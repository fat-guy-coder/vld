{
  "_meta": {
    "purpose": "AI guidance for LD framework generation. Prioritizes clarity, speed, and strict adherence to goals.",
    "version": "1.7.4-final-restored",
    "lastUpdated": "2026-01-02T22:24:47.118Z"
  },
  "project": {
    "name": "ld",
    "goal": "light!fast!performance!typescript!vue!react! - Beat SolidJS on key metrics.",
    "slogan": "极致性能前端框架",
    "description": "零虚拟DOM、Signal驱动、完全兼容Vue3和React Hooks的前端框架。",
    "performanceTargets": {
      "signalCreate": "<0.01ms",
      "signalGet": "<0.001ms",
      "signalSet": "<0.005ms",
      "libraryBundleSize": "<10KB gzipped (For individual library health check only)",
      "finalAppBundleSize": "The final bundled size of a standard application (e.g., TodoMVC) MUST be smaller than equivalent apps built with competing frameworks. This is the primary measure of size performance.",
      "componentMount": "<0.1ms",
      "componentUpdate": "<0.05ms",
      "benchmarkGoal": "Metrics must aim to surpass competing frameworks in benchmarks/frameworks-data.json."
    }
  },
  "currentState": {
    "module": "runtime-dom",
    "file": null,
    "status": "pending",
    "notes": "runtime-core模块已完成，准备开始runtime-dom模块。"
  },
  "aiDirectives": {
    "corePrinciples": [
      "MUST_PROPAGATE_CHANGES_TO_ALL_DEPENDENCIES",
      "MUST_READ_THIS_FILE_FIRST",
      "MUST_READ_PACKAGE_JSON_FIRST",
      "MUST_TREAT_MODULE_TS_AS_SINGLE_SOURCE_OF_TRUTH",
      "MUST_LINT_AFTER_EDIT",
      "MUST_SUGGEST_GUIDANCE_IMPROVEMENTS",
      "MUST_FOLLOW_WORKFLOW_SEQUENCE",
      "MUST_ANALYZE_EXISTING_CODE_BEFORE_GENERATION",
      "MUST_VALIDATE_EACH_STEP_WITH_TESTS",
      "MUST_ANALYZE_FULL_TEST_FAILURE_LOGS_VIA_AI_RUNNER",
      "MUST_UPDATE_`currentState`_AFTER_EACH_ACTION",
      "MUST_USE_CHINESE_FOR_ALL_COMMENTS_JSDOC_AND_DOCS",
      "MUST_PROPAGATE_CHANGES_TO_ALL_DEPENDENCIES",
      "MUST_VERIFY_EXTERNAL_TOOL_DEPENDENCIES"
    ],
    "prohibitions": [
      "NO_SKIP_VALIDATION_OR_TESTS",
      "NO_MODIFY_THIS_GUIDANCE_FILE",
      "NO_CODE_THAT_VIOLATES_`architecture`_PRINCIPLES",
      "NO_GENERATE_CODE_WITHOUT_ANALYZING_EXPORTS",
      "NO_PROCEED_IF_TESTS_FAIL",
      "NO_FILE_SCOPED_STATE_VARIABLES"
    ],
    "continuousImprovement": "If optimization opportunities are discovered that should be standardized, you MUST suggest updating this guidance file.",
    "codeGenerationRules": {
      "NO_UNUSED_VARIABLES": "All declared variables and imports MUST be used or removed.",
      "OPTIMAL_LOOPS": "Use reverse for-loops for unordered iteration in hot paths; cache array length for ordered iteration.",
      "OPTIMAL_ALGORITHMS": "Core algorithms MUST have the lowest possible time and space complexity."
    },
    "stateManagementProtocol": {
      "sourceOfTruth": "All state MUST be managed via `packages/reactivity/src/store.ts`.",
      "global": "All cross-module shared state MUST be in the `globalState` object.",
      "instance": "All component-specific state MUST use `createInstanceStore` for isolation.",
      "noFileScopeVars": "STRICTLY FORBIDDEN: Do NOT use file-scoped variables for state."
    },
    "startupChecklist": {
      "step1": "Read this guidance file (gemini-optimized-guidance.json).",
      "step2": "Read package.json to understand available scripts and dependencies.",
      "step3": "Optionally, read context files from workflow.details as needed."
    }
  },
  "workflow": {
    "sequence": [
      "1_ANALYZE_CODEBASE",
      "2_DESIGN_CODE_STRUCTURE",
      "3_GENERATE_CODE",
      "4_UPDATE_MODULE_EXPORTS",
      "5_GENERATE_OR_UPDATE_TESTS",
      "6_EXECUTE_TESTS",
      "7_PERFORMANCE_TUNING",
      "8_BUILD_MODULE",
      "9_ANALYZE_BUNDLE",
      "10_UPDATE_CURRENT_STATE"
    ],
    "details": {
      "1_ANALYZE_CODEBASE": {
        "description": "Analyze context. Priority 1: Read `packages/module.ts`, the Single Source of Truth for all public APIs.",
        "filesToAnalyze": [
          "packages/module.ts",
          "packages/{currentState.module}/src/index.ts"
        ]
      },
      "3_GENERATE_CODE": {
        "description": "Generate TypeScript code for the target file.",
        "rules": [
          "Adhere strictly to `codeStyle` and `templates`.",
          "Ensure all `qualityGates` are met.",
          "Performance is the highest priority."
        ]
      },
      "4_UPDATE_MODULE_EXPORTS": {
        "description": "Update the module's `index.ts` and then the main `packages/module.ts`.",
        "filesToUpdate": [
          "packages/{currentState.module}/src/index.ts",
          "packages/module.ts"
        ],
        "rules": [
          "`packages/module.ts` MUST fully re-export all public APIs from every module's `index.ts`.",
          "Every export block in `packages/module.ts` MUST have a JSDoc comment indicating its source module (e.g., `// from @ld/reactivity`)."
        ]
      },
      "5_GENERATE_OR_UPDATE_TESTS": {
        "description": "Create or update the test file for the generated code.",
        "pathTemplate": "packages/{currentState.module}/test/{filename}.test.ts",
        "requiredCoverage": [
          "normalCase",
          "boundaryCase",
          "errorCase",
          "regressionCase_afterFix"
        ]
      },
      "6_EXECUTE_TESTS": {
        "description": "Run tests for the modified file and ensure 100% pass rate. Fix any failures before proceeding.",
        "command": "pnpm test:ai -- packages/{currentState.module}/test/{filename}.test.ts"
      },
      "7_PERFORMANCE_TUNING": {
        "description": "Conduct performance and memory analysis. Skippable for non-runtime modules (e.g., `cli`).",
        "steps": [
          "1_CREATE_OR_UPDATE_BENCHMARKS",
          "2_RUN_BENCHMARKS_AND_ANALYZE",
          "3_CREATE_OR_UPDATE_MEMORY_TESTS",
          "4_RUN_MEMORY_TESTS_AND_ANALYZE",
          "5_IMPLEMENT_OPTIMIZATIONS",
          "6_VALIDATE_GAINS"
        ],
        "commands": {
          "benchmark": "pnpm bench",
          "memory": "pnpm tsx scripts/memory.mts"
        },
        "qualityGate": "Performance and memory usage must meet targets and be competitive with data in `statistics/frameworks-data.json`.",
        "rules": [
          "If API changes are made during optimization, corresponding unit tests MUST be updated before re-running `6_EXECUTE_TESTS` to ensure correctness."
        ]
      },
      "8_BUILD_MODULE": {
        "description": "Package the current module for distribution.",
        "tool": "Rollup/tsup",
        "rules": [
          "Do not include test, benchmark, or memory files in the final bundle."
        ]
      },
      "9_ANALYZE_BUNDLE": {
        "description": "Analyze the final library bundle size and dependencies. Optimize if not as expected.",
        "command": "pnpm analyze",
        "qualityGate": "Library bundle size must align with performance targets. No unexpected dependencies."
      },
      "10_UPDATE_CURRENT_STATE": {
        "description": "Update the `currentState` object in this file to prepare for the next module."
      }
    }
  },
  "architecture": {
    "nonNegotiable": [
      "zeroVirtualDOM",
      "signalBasedReactivity",
      "fullVue3AndReactCompatibility",
      "absoluteTypeSafety",
      "extremePerformance",
      "minimalFinalAppBundleSize",
      "minimalAotMemoryFootprint",
      "typeFileIsolationForCircularDependencies"
    ],
    "lazyLoading": {
      "components": "All components and routes MUST support code-splitting via dynamic import().",
      "styles": "Compiler MUST output separate CSS files. Runtime MUST dynamically inject styles on first component mount.",
      "fetchStrategy": "Runtime MUST allow custom fetch logic, defaulting to native browser import() or fetch()."
    },
    "compilation": {
      "strategy": "AOT (Ahead-of-Time) only. Development-time speed is secondary to final output quality.",
      "goal": "Generate the most optimal, performant, and smallest possible native JavaScript code for direct DOM manipulation. The final bundle's performance, size, and memory usage are the highest priorities.",
      "ld": {
        "parser": "@ld/compiler-ld (custom, Babel-based)",
        "transformer": "@ld/compiler-ld (custom, Babel-based)",
        "generator": "@ld/compiler-ld (custom, Babel-based)",
        "output": "Direct, fine-grained native DOM manipulations. Zero VDOM."
      },
      "sfc": {
        "parser": "@vue/compiler-sfc",
        "transformer": "@ld/compiler-core (custom)",
        "generator": "@ld/compiler-core (custom)",
        "output": "Direct DOM manipulations, no VDOM."
      },
      "jsx": {
        "parser": "@babel/parser",
        "transformer": "@ld/babel-plugin-ld",
        "output": "Calls to `@ld/runtime-jsx` functions, no VDOM."
      }
    }
  },
  "modules": {
    "generationOrder": [
      "reactivity", "runtime-core", "runtime-dom", "runtime-jsx", "react", "vue", 
      "compiler-core", "compiler-sfc", "router", "ld", "vite-plugin", "cli", "devtools", "babel-plugin-ld"
    ]
  },
  "codeStyle": {
    "naming": {
      "functions": "camelCase",
      "types": "PascalCase",
      "constants": "UPPER_SNAKE_CASE"
    },
    "imports": {
      "internal": "from './index'",
      "external": "from '@ld/moduleName'",
      "typeOnly": "import type { ... }"
    },
    "exports": {
      "rule": "In a module's `index.ts`, group exports by source file. In `packages/module.ts`, create a dedicated block for each module and re-export all its public APIs with a clear comment indicating the source (e.g., `// from @ld/reactivity`)."
    }
  },
  "templates": {
    "jsdoc": {
      "function": {
        "required": ["@description", "@param", "@returns", "@example", "@performance", "@since"],
        "example": "/**\n * @description ...\n * @param ...\n * @returns ...\n * @example ...\n * @performance ...\n * @since v0.1.0\n */"
      }
    }
  },
  "testing": {
    "strategy": "Intelligent Selective Testing",
    "description": "Test runners (`test.mts`, `test-ai.mts`) dynamically select packages to test based on `generate-code-guidance.json` status.",
    "logic": {
      "sourceOfTruth": "ai-generate-code-guidance/generate-code-guidance.json",
      "helperScript": "scripts/utils/get-active-packages.mts",
      "criteria": "Only packages with status 'completed' or 'active' are tested.",
      "fallback": "If guidance file is unreadable, all packages are tested."
    },
    "commands": {
      "ai_runner": "pnpm test:ai",
      "standard_runner": "pnpm test"
    }
  },
  "tooling": {
    "linter": "ESLint",
    "formatter": "Prettier",
    "bundler": "Rollup/tsup",
    "benchmark": "tinybench"
  },
  "qualityGates": {
    "performance": "All code must be JIT-friendly with minimal GC overhead.",
    "dependencies": "Dependency graph must be a DAG (no circular dependencies).",
    "types": "`any` type is strictly forbidden.",
    "typescriptValidation": "Source code in `packages/**/src` MUST have zero TS errors. For other files (scripts, tests, benchmarks), ensuring no errors in the IDE's TS server is sufficient; ESLint is not mandatory.",
    "lintAfterEdit": "After any modification to a `.ts` or `.mts` file, you MUST run the linter to ensure zero errors before proceeding.",
    "testing": "Every new feature or fix must be accompanied by a passing test."
  }
}
